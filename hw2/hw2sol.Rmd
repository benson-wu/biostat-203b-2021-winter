---
title: "Biostat 203B Homework 2"
subtitle: Due Feb 5 @ 11:59PM
author: Benson Wu
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-0.4"
}
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference?

In this homework, we stick to the tidyverse. 


**Solution**
We can use the library `tictoc` to measure code run time. 

```{r}
if(!require(tictoc)){
    install.packages("tictoc")
    library(tictoc)
}

tic("read.csv")
df1 <- read.csv("/usr/203b-data/mimic-iv/core/admissions.csv.gz")
toc()

tic("read_csv")
df2 <- read_csv("/usr/203b-data/mimic-iv/core/admissions.csv.gz")
toc()

tic("data.table")
df3 <- fread("/usr/203b-data/mimic-iv/core/admissions.csv.gz")
toc()
```

`fread` reads the compressed file the fastest among the three functions. 

We will remove the other data frames and only keep the first for the rest of the assignment.

```{r}
df_admissions<-df1
remove("df1", "df2", "df3")
```




## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs:   

- how many unique `stay_id`?  
- how many unique `subject_id`?  
- length of ICU stay  
- first ICU unit  
- last ICU unit  

**Solution**
Let's read in the data first.
```{r}
df_icu <- fread("/usr/203b-data/mimic-iv/icu/icustays.csv.gz")
```

```{r}
n_distinct(df_icu$stay_id)
```
There are 69,619 distinct stay ID values not including missing values.

```{r}
n_distinct(df_icu$subject_id)
```
There are 50,048 distinct subject ID values not including missing values.

```{r}
df_icu %>% ggplot(aes(los)) + geom_boxplot() + xlab("Days")
summary(df_icu$los)
```

We can visualize the data with a boxplot, but it is not too helpful since there are some extreme outliers. We can run some simple summary statistics to get a better sense of how the data is distributed. The median stay is 2.06 days. 


```{r}
df_icu %>% ggplot(aes(x=factor(first_careunit))) + geom_bar(stat="count") + 
        xlab("First ICU unit") +
        theme(axis.text.x=element_text(angle=60,hjust=1)) + 
        geom_text(stat='count', aes(label=..count..), vjust=-1)
```
There are 11 distinct First ICU units. The frequency counts are visualized and labeled with the frequqency counts for each unit. 

```{r}
df_icu %>% ggplot(aes(x=factor(last_careunit))) + geom_bar(stat="count") + 
        xlab("First ICU unit") +
        theme(axis.text.x=element_text(angle=60,hjust=1)) + 
        geom_text(stat='count', aes(label=..count..), vjust=-1)
```
There are 9 distinct First ICU units. The frequency counts are visualized and labeled with the frequqency counts for each unit. 


## Q4. `admission` data

Information of the patients admitted into hospital is available in `ADMISSION.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  
- number of deaths in each year  
- admission type  
- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on unique patients. 


**Solution**

```{r}
df_admissions$admit_year <- year(df_admissions$admittime)

df_admissions %>% ggplot(aes(admit_year)) + geom_bar() + xlab("Admit year") +
                  scale_x_continuous(n.breaks = 20) +
                  theme(axis.text.x=element_text(angle=60,hjust=1)) 
```

The count of each admit year is visualized in a bar graph. The amount of people admitted seem to increase until about 2030 and then stabilize until 2189. Starting form 2190, the number of admissions significnatly decrease. 


```{r}
df_admissions$admit_month <- month(df_admissions$admittime)

months <-c("Jan.", "Feb.", "Mar.","Apr.","May", "June", "July", "Aug.", "Sept.", "Oct.", "Nov.", "Dec.")
df_admissions %>% ggplot(aes(x=factor(admit_month))) + geom_bar(stat="count") + 
        xlab("Admit month") + scale_x_discrete(labels=months) +
        theme(axis.text.x=element_text(angle=60,hjust=1))
```

The count of each admission month is visualized in a bar graph. The admission months are relatively uniformly distributed. 


```{r}
df_admissions$admit_month_day <- mday(df_admissions$admittime)
df_admissions %>% ggplot(aes(x=factor(admit_month_day))) + geom_bar(stat="count") + 
        xlab("Admit month day") +
        theme(axis.text.x=element_text(angle=60,hjust=1))
```
There seem to be a uniform amount of admissions from the 1st to 28th of each month, but there are fewer admissions 29th-31st compared to the other days. There could be especially fewer admissions on the 31st because there are only 7 months with 31 days. 


```{r}
df_admissions$admit_week_day <- wday(df_admissions$admittime)
days <-c("Mon", "Tues", "Wed", "Thurs", "Fri", "Sat", "Sun")
df_admissions %>% ggplot(aes(x=factor(admit_week_day))) + geom_bar(stat="count") + 
        xlab("Admit week day") + scale_x_discrete(labels=days)
        theme(axis.text.x=element_text(angle=60,hjust=1))
```

The day of the week that individuals are admited are uniformly distributed. 

```{r}
df_admissions$admit_hour <- hour(df_admissions$admittime)
df_admissions %>% ggplot(aes(x=factor(admit_hour))) + geom_bar(stat="count") + 
        xlab("Admission hour") +
        theme(axis.text.x=element_text(angle=60,hjust=1))
```

Peak admissions seem to happen between midnight and 1 AM. There is also a sudden spike in admissions between the 7AM and 8 AM. 


### THERE IS A MISTAKE HERE. COME BACK AND FIX LATER (1/28)
```{r}
df_admissions$death <- if_else(is.na(df_admissions$deathtime), 0, 1)

df_admissions %>% ggplot(aes(x=factor(admit_year), y=death)) + 
                  geom_bar(stat="identity") + xlab("Admit year") +
                  
                  theme(axis.text.x=element_text(angle=60,hjust=1)) 
```


```{r}
df_admissions %>% ggplot(aes(x=factor(admission_type))) + geom_bar(stat="count") + 
        xlab("Admit type") +
        theme(axis.text.x=element_text(angle=60,hjust=1))
```

The most common admission type is EW Emergency. 


- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death 


## Q5. `patient` data

Explore `patients.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/core/patients/>) and summarize following variables using appropriate numerics and graphs:  

- `gender`  
- `anchor_age` (explain pattern you see)

**Solution**

```{r}
df_patients <- fread("/usr/203b-data/mimic-iv/core/patients.csv.gz")

df_patients %>% ggplot(aes(x=factor(gender))) + geom_bar(stat="count") + 
        xlab("Gender") +scale_x_discrete(labels=c("Female", "Male"))
```

There are slightly more females than males 

```{r}
df_patients %>% ggplot(aes(anchor_age)) + geom_histogram() + 
        xlab("Age in anchor year") 
```

There are a lot of people who report an age of 0 during the anchor year.

## Q6. Lab results

`labevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/hosp/labevents/>) contains all laboratory measurements for patients. 

We are interested in the lab measurements of creatinine, potassium, sodium, chloride, bicarbonate, hematocrit, white blood cell count, glucose, magnesium, calcium, phosphorus, and lactate. Find the `itemid`s of these lab measurements from `d_labitems.csv.gz` and retrieve a subset of `labevents.csv.gz` only containing these items.

## Q7. Vitals from chartered events

We are interested in the vitals for ICU patients: heart rate, mean and systolic blood pressure (invasive and noninvasive measurements combined), body temperature, SpO2, and respiratory rate.

`chartevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`d_items.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

## Q8. Putting things together

Let us create a tibble for all ICU stays, where rows are  

- first ICU stay of each unique patient  
- adults (age at admission > 18)  

and columns contains at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- first lab measurements during ICU stay  
- first vitals measurement during ICU stay  
- an indicator variable whether the patient died within 30 days of hospital admission  
